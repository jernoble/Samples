---
title: AVSyncTest
tags: MediaRecorder
---
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    canvas, video {
        background-color: black;
        max-width: 100%;
    }
</style>
<script src="bip-bop.js"></script>
<script>
window.addEventListener('load', event => {
    const bipBopWorker = new Worker("bip-bop-worker.js");

    let canvas = document.querySelector('canvas');
    let video = document.querySelector('video');
    let download = document.getElementById('download');
    let audioData = new Int16Array(canvas.width * 2);

    let options = {
        currentTime: { value: 0, timescale: 24 },
        endTime: { value: 1, timescale: 24 },
        frameDuration: { value: 1, timescale: 24 },
        segmentDuration: 10.0,
        description: "Bip Bop Canvas",
        colors: {
            black:   'black',
            white:   'white',
            grey:    'grey',
            yellow:  'yellow',
            cyan:    'cyan',
            green:   'green',
            purple:  'purple',
            red:     'red',
            blue:    'blue',
            background: 'black',
            foreground: 'white',
        },
        audioData: audioData,
    };
    bipBopWorker.postMessage({type: 'set-options', options: options});

    let stream = canvas.captureStream();
    let track = stream.getTracks()[0];
    let recorder = new MediaRecorder(stream, {mimeType: 'video/mp4'});

    let mediaData = new Blob([], {type: 'video/mp4'});
    let mediaURL = URL.createObjectURL(mediaData);

    let interval;

    recorder.addEventListener('dataavailable', event => {
        URL.revokeObjectURL(mediaURL);
        mediaData = new Blob([mediaData, event.data]);
        mediaURL = URL.createObjectURL(mediaData);

        while (video.firstChild)
            video.removeChild(video.firstChild);
        let source = document.createElement('source');
        source.type = 'video/mp4';
        source.src = mediaURL;
        video.appendChild(source);
        video.load();

        download.href = mediaURL;
        download.download = 'video.mp4';
    });

    let start = document.getElementById('start')
    start.addEventListener('click', event => {
        if (interval)
            return;

        let intervalDuration = 1000 * options.frameDuration.value / options.frameDuration.timescale;

        let paintAndIncrement = () => {
            if (options.currentTime.value / options.currentTime.timescale % options.segmentDuration == 0)
                recorder.requestData();

            track.requestFrame();

            options.currentTime.value += 1;
            options.endTime.value += 1;
            bipBopWorker.postMessage({type: 'paint-and-increment'});
        };

        recorder.start();

        interval = setInterval(paintAndIncrement, intervalDuration);
        paintAndIncrement();
    });

    let stop = document.getElementById('stop');
    stop.addEventListener('click', event => {
        if (!interval)
            return;
        clearInterval(interval);
        interval = null;
        recorder.stop();
    });

    document.getElementById('size').addEventListener('change', event => {
        switch (event.target.value) {
        case '360p':
            video.width = canvas.width = 480;
            video.height = canvas.height = 360;
            break;
        case '480p':
            video.width = canvas.width = 640;
            video.height = canvas.height = 480;
            break;
        case '720p':
            video.width = canvas.width = 1280;
            video.height = canvas.height = 720;
            break;
        case '1080p':
            video.width = canvas.width = 1920;
            video.height = canvas.height = 1080;
            break;
        }
        bipBopWorker.postMessage({type: 'set-options', options: options});
    });

    document.getElementById('description').addEventListener('input', event => {
        options.description = event.target.value;
        bipBopWorker.postMessage({type: 'set-options', options: options});
    });

    document.getElementById('segment-duration').addEventListener('change', event => {
        let segmentDuration = parseInt(event.target.value, 10);
        if (Number.isNaN(segmentDuration))
            return;
        options.segmentDuration = segmentDuration;
        bipBopWorker.postMessage({type: 'set-options', options: options});
    });

    let offscreen = canvas.transferControlToOffscreen();
    bipBopWorker.postMessage({type: 'set-canvas', canvas: offscreen}, [offscreen]);
});
</script>
<body>
    <br>
    Size: <select id=size>
        <option value=360p>360p</option>
        <option value=480p selected>480p</option>
        <option value=720p>720p</option>
        <option value=1080p>1080p</option>
    </select>
    <br>
    Description: <input id=description type="text" id="description" value="Bip Bop Canvas" />
    <br>
    Segment Duration: <select id=segment-duration>
        <option value=1>1s</option>
        <option value=5>5s</option>
        <option value=10 selected>10s</option>
        <option value=60>1m</option>
    </select>
    <br>

    <button id=start>start</button> <button id=stop>stop</button> <a id="download"><button>download</button></a>
    <br>
    <canvas width=640 height=480></canvas><video width=640 height=480 controls playsinline></video>
</body>
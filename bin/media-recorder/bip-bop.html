---
title: Bip-Bop Generator
tags: MediaRecorder
---
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    canvas, video {
        background-color: black;
        max-width: 100%;
    }
</style>
<script src="bip-bop.js"></script>
<script>
window.addEventListener('load', event => {
    const bipBopWorker = new Worker("bip-bop-worker.js");

    let canvas = document.querySelector('canvas');
    let video = document.querySelector('video');
    let download = document.getElementById('download');
    let audioData = new Int16Array(canvas.width * 2);
    var segmentDurationReached = false;
    let fps = 24;
    let startingFrame = 0;

    let options = {
        frameDuration: { value: 1, timescale: fps },
        segmentDuration: 10.0,
        description: "Bip Bop Canvas",
        colors: {
            black:   'black',
            white:   'white',
            grey:    'grey',
            yellow:  'yellow',
            cyan:    'cyan',
            green:   'green',
            purple:  'purple',
            red:     'red',
            blue:    'blue',
            background: 'black',
            foreground: 'white',
        },
        audioData: audioData,
    };
    bipBopWorker.postMessage({type: 'set-options', options: options});
    bipBopWorker.postMessage({type: 'set-time', currentTime: { value: startingFrame, timescale: fps }, endTime: { value: startingFrame + 1, timescale: fps } });

    let stream = canvas.captureStream();
    let track = stream.getTracks()[0];
    let recorder = new MediaRecorder(stream, {mimeType: 'video/mp4'});

    let mediaData = new Blob([], {type: 'video/mp4'});
    let mediaURL = URL.createObjectURL(mediaData);

    let interval;

    recorder.addEventListener('dataavailable', event => {
        URL.revokeObjectURL(mediaURL);
        mediaData = new Blob([mediaData, event.data]);
        mediaURL = URL.createObjectURL(mediaData);

        while (video.firstChild)
            video.removeChild(video.firstChild);
        let source = document.createElement('source');
        source.type = 'video/mp4';
        source.src = mediaURL;
        video.appendChild(source);
        video.load();

        download.href = mediaURL;
        download.download = 'video.mp4';
    });

    let start = () => {
        if (interval)
            return;


        let intervalDuration = 1000 * options.frameDuration.value / options.frameDuration.timescale;

        let paintAndIncrement = () => {
            if (segmentDurationReached) {
                recorder.requestData();
                segmentDurationReached = false;
            }

            track.requestFrame();
            bipBopWorker.postMessage({type: 'paint-and-increment'});
        };

        recorder.start();

        interval = setInterval(paintAndIncrement, intervalDuration);
        paintAndIncrement();
        document.getElementById('start').disabled = true;
        document.getElementById('stop').disabled = false;
    };

    let stop = () => {
        if (!interval)
            return;
        clearInterval(interval);
        interval = null;
        recorder.stop();
        document.getElementById('start').disabled = false;
        document.getElementById('stop').disabled = true;
    };

    document.getElementById('start').addEventListener('click', start);
    document.getElementById('stop').addEventListener('click', stop);
    document.getElementById('reset').addEventListener('click', event => {
        stop();
        bipBopWorker.postMessage({type: 'set-options', options: options});
        bipBopWorker.postMessage({type: 'set-time', currentTime: { value: startingFrame, timescale: fps }, endTime: { value: startingFrame + 1, timescale: fps } });

        video.innerHTML = '';
        video.load();
    });

    document.getElementById('size').addEventListener('change', event => {
        var width = video.width;
        var height = video.height;

        switch (event.target.value) {
        case '360p':
            width = 480;
            height = 360;
            break;
        case '480p':
            width = 640;
            height = 480;
            break;
        case '720p':
            width = 1280;
            height = 720;
            break;
        case '1080p':
            width = 1920;
            height = 1080;
            break;
        default:
            return;
        }
        video.width = width;
        video.height = height;
        bipBopWorker.postMessage({type: 'set-size', width: width, height: height});
        bipBopWorker.postMessage({type: 'set-options', options: options});
    });

    document.getElementById('description').addEventListener('input', event => {
        options.description = event.target.value;
        bipBopWorker.postMessage({type: 'set-options', options: options});
    });

    document.getElementById('segment-duration').addEventListener('change', event => {
        let segmentDuration = parseInt(event.target.value, 10);
        if (Number.isNaN(segmentDuration))
            return;
        options.segmentDuration = segmentDuration;
        bipBopWorker.postMessage({type: 'set-options', options: options});
    });

    document.getElementById('frames-per-second').addEventListener('change', event => {
        let inFPS = parseInt(event.target.value, 10);
        if (Number.isNaN(fps))
            return;
        fps = inFPS;
        options.frameDuration = { value: 1, timescale: fps };
        bipBopWorker.postMessage({type: 'set-options', options: options});
        if (!interval)
            bipBopWorker.postMessage({type: 'set-time', currentTime: { value: 0, timescale: fps }, endTime: { value: 1, timescale: fps } });
    });

    document.getElementById('starting-frame').addEventListener('input', event => {
        let inStartingFrame = parseInt(event.target.value, 10);
        if (Number.isNaN(inStartingFrame))
            return;
        startingFrame = inStartingFrame;
        if (!interval)
            bipBopWorker.postMessage({type: 'set-time', currentTime: { value: startingFrame, timescale: fps }, endTime: { value: startingFrame + 1, timescale: fps } });
    });


    video.addEventListener('emptied', event => {
        download.href = '';
        download.download = 'video.mp4';
        download.querySelector('button').disabled = true;
    })

    video.addEventListener('loadedmetadata', event => {
        download.href = mediaURL;
        download.download = 'video.mp4';
        download.querySelector('button').disabled = false;
    })

    let offscreen = canvas.transferControlToOffscreen();
    bipBopWorker.postMessage({type: 'set-canvas', canvas: offscreen}, [offscreen]);
    bipBopWorker.addEventListener('message', event => {
        switch (event.data.type) {
        case 'segment-duration-reached':
            segmentDurationReached = true;
            break;
        }
    });
});
</script>
<body>
    <br>
    Size: <select id=size>
        <option value=360p>360p</option>
        <option value=480p selected>480p</option>
        <option value=720p>720p</option>
        <option value=1080p>1080p</option>
    </select>
    <br>
    Description: <input id=description type="text" id="description" value="Bip Bop Canvas" />
    <br>
    Segment Duration: <select id=segment-duration>
        <option value=1>1s</option>
        <option value=5>5s</option>
        <option value=10 selected>10s</option>
        <option value=60>1m</option>
    </select>
    <br>

    FPS: <select id=frames-per-second>
        <option value=15>15 fps</option>
        <option value=24 selected>24 fps</option>
        <option value=30>30 fps</option>
        <option value=60>60 fps</option>
    </select>
    <br>

    Starting Frame: <input id=starting-frame type=number value=0>
    <br>

    <button id=start>start</button> <button id=stop disabled>stop</button> <a id="download"><button disabled=true>download</button></a> <button id=reset>reset</button>
    <br>
    <canvas width=640 height=480></canvas><video width=640 height=480 controls playsinline></video>
</body>